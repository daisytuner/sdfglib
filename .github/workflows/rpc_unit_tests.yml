name: RPC Unit Tests

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  rpc-tests:
    runs-on:
      group: dahlia
      labels: openmp
    container:
      image: daisytuner/docc-build-env-llvm19-base:latest-amd64
      options: >-
        --cap-add=PERFMON

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Mark GitHub Actions workdir as safe
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'

      - name: Install Node dependencies for transfer server
        working-directory: ${{ github.workspace }}/examples/transfer-server
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Configure and build with tests
        working-directory: ${{ github.workspace }}
        run: |
          mkdir build
          cd build
          cmake \
            -G Ninja \
            -DCMAKE_C_COMPILER=clang-19 \
            -DCMAKE_CXX_COMPILER=clang++-19 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DBUILD_TESTS:BOOL=ON \
            ..
          ninja -j"$(nproc)"

      - name: Start transfer server and run RPC tests
        working-directory: ${{ github.workspace }}
        env:
          SDFG_TEST_SDFG_PATH: ${{ github.workspace }}/examples/input/transfertuning/matmul_sdfg.json
          SDFG_TEST_SEQUENCE_PATH: ${{ github.workspace }}/examples/input/transfertuning/matmul_sequence.json
        shell: bash
        run: |
          set -e

          # Start the Node transfer server in the background
          cd examples/transfer-server
          npm run dev &
          SERVER_PID=$!

          # Give the server a moment to start
          sleep 5

          # Run RPC unit tests (sdfgrpc_test links against the local transfer transform)
          cd "$GITHUB_WORKSPACE/build"
          ./rpc/tests/sdfgrpc_test

          # Shut down the server
          kill "$SERVER_PID" || true
